pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
board_cols=7
board_rows=7
function _init()
  sprs = {1,2,3,17,18,19,33}
  board = new_board()
  poke(0x5f2d,1)
  clicked=false
  -- stat(32) x
  -- stat(33) y
  -- stat(34) click
  selected = {-1,-1}
  t=0
end

function _draw()
  cls()
  draw_board()
  spr(0,stat(32),stat(33))
end

function _update()
  do_clicks()
  do_matches(board)
end

function do_matches(board)
  for i=0,board_cols do
    for j=0,bord_rows do
      neighbors = get_all_neighbors(board, row, col)
      for neighbor in all(neighbors) do
        -- can't include neighbors which were already checked in previous rounds
        neighbor.checked = True
        if neighbor.val == board[col][row] then end
      end
    end
  end
  -- for every spot
  -- find all neighbors of the spot (todo: do I look diagonally too? (no))
  -- find all that are the same type as currently assesed spot
  -- iterate through all matching types and check all neighbors, keep doing until no more matching
  -- recursive?
  -- if count of matched neighbors >3, eliminated those spots, fill in and award points
end

function find_and_check_neighbors(board, checked_neighbors, col, row)
  add(checked_neighbors, {col=col-1, row=row, val=board[col-1][row]})
  add(checked_neighbors, {col=col+1, row=row, val=board[col+1][row]})
  add(checked_neighbors, {col=col, row=row-1, val=board[col][row-1]})
  add(checked_neighbors, {col=col, row=row+1, val=board[col][row+1]})
end

function do_clicks()
  if clicked==false and stat(34) == 1 then
    clicked=true
    x=stat(32)
    y=stat(33)
    col=flr(((x+4)/12))
    row=flr(((y+4)/12))
    if selected[1]==-1 then
      selected={flr(col),flr(row)}
      printh(x.." "..y)
      printh(flr(selected[1]).." "..flr(selected[2]))
    elseif is_valid_selection(selected[1], selected[2], col, row) then
      -- todo, can only swap on correct areas
      tmp = {}
      tmp = board[row][col]
      board[row][col] = board[selected[2]][selected[1]]
      board[selected[2]][selected[1]] = tmp
      selected={-1,-1}
    end
  end
  t+=1
  if t%30 == 0 then
    clicked=false
  end
end

function new_board()
  local board = {}
  for i=0,BOARD_COLS do
    board[i] = {}
    debugstr = ""
    for j=0,BOARD_ROWS do
      board[i][j] = sprs[flr(rnd(#sprs))+1]
      debugstr = debugstr..", "..board[i][j]
    end
    printh(debugstr)
  end
  return board
end

function draw_board()
  modx=0
  for i=0,BOARD_COLS do
    for j=0,BOARD_ROWS do
      --printh("debug i + j "..i.." + "..j.." = "..(i+j).." mod2 "..((i+j)%2))
      if (i+j)%2==0 then
        for k=-2,9 do
          for l=-2,9 do
            pset(j*12+k, i*12+l, 1)
          end
        end
      end
      spr(board[i][j],j*12,i*12)
    end
  end
  if selected[1] >=0 then
    rect((selected[1]*12)-2,
         (selected[2]*12)-2,
         (selected[1]*12)+10,
         (selected[2]*12)+10,8)
    rect(((selected[1]-1)*12)-2,
         ((selected[2]-1)*12)-2,
         ((selected[1]+2)*12)-2,
         ((selected[2]+2)*12)-2, 11)
  end
end

function is_valid_selection(oldcol, oldrow, newcol, newrow)
  return abs(newcol - oldcol) + abs(newrow - oldrow) <= 1
end
__gfx__
000000000000b300000ddd0000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000b300000ddddd000000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
007007000a9999400dd0d0dd50555005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000a9d999140d00d00d55555505000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00088000a9dd91140ddddddd55555550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700999999940dd000dd05000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000099ddd1940ddddddd05000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000099999400d0d0d0d05000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000007770007777000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000007770077777077666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000999770770707776000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000a9999960700700750000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aa999900777077705000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaa99400077777000550000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000aaa94000070707000005500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000aaa0000007770000000055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000e000007b30000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000e200076635000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000ee2220766336500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000e89e000766366500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000e98e000766636500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000ee2ee0000666666500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000022000000666666500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000002000000655454200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
11177711110007777000001111111e1111000777700000111111115111000007770000111111b311110000000e00000000000000000000000000000000000000
11777771110077666600001111111e211100776666000011111111151100007777700011111b3111110000000e20000000000000000000000000000000000000
177171771100760000600011111ee22211007600006000115155511511000770707700111a9999411100000ee222000000000000000000000000000000000000
17117117110050000006001111e89e111100500000060011555555151100070070070011a9d99914110000e89e00000000000000000000000000000000000000
17771777110005000000001111e98e111100050000000011555555511100077707770011a9dd9114110000e98e00000000000000000000000000000000000000
117777711100005500000011ee2ee1111100005500000011151111511100007777700011999999941100ee2ee000000000000000000000000000000000000000
11717171110000005500001112211111110000005500001115111151110000707070001199ddd194110002200000000000000000000000000000000000000000
11177711110000000055001111211111110000000055001115111151110000077700001119999941110000200000000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
077770000011111ddd1111000000b30000111111b31111000000000000111111b31111000000b300001111111151110000000000000000000000000000000000
77666600001111ddddd11100000b30000011111b31111100000007770011111b31111100000b3000001111111115110000000000000000000000000000000000
7600006000111dd1d1dd11000a99994000111a99994111000009997700111a99994111000a999940001151555115110000000000000000000000000000000000
5000000600111d11d11d1100a9d999140011a9d9991411000a9999960011a9d999141100a9d99914001155555515110000000000000000000000000000000000
0500000000111ddddddd1100a9dd91140011a9dd911411000aa999900011a9dd91141100a9dd9114001155555551110000000000000000000000000000000000
0055000000111dd111dd11009999999400119999999411000aaa9940001199999994110099999994001115111151110000000000000000000000000000000000
0000550000111ddddddd110099ddd194001199ddd19411000aaa9400001199ddd194110099ddd194001115111151110000000000000000000000000000000000
0000005500111d1d1d1d110009999940001119999941110000aaa000001119999941110009999940001115111151110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
111777111100000ddd000011111111511100000ddd000011111ddd111100000ddd00001111111e1111000000b300000000000000000000000000000000000000
11777771110000ddddd0001111111115110000ddddd0001111ddddd1110000ddddd0001111111e211100000b3000000000000000000000000000000000000000
1771717711000dd0d0dd00115155511511000dd0d0dd00111dd1d1dd11000dd0d0dd0011111ee22211000a999940000000000000000000000000000000000000
1711711711000d00d00d00115555551511000d00d00d00111d11d11d11000d00d00d001111e89e111100a9d99914000000000000000000000000000000000000
1777177711000ddddddd00115555555111000ddddddd00111ddddddd11000ddddddd001111e98e111100a9dd9114000000000000000000000000000000000000
1177777111000dd000dd00111511115111000dd000dd00111dd111dd11000dd000dd0011ee2ee111110099999994000000000000000000000000000000000000
1171717111000ddddddd00111511115111000ddddddd00111ddddddd11000ddddddd001112211111110099ddd194000000000000000000000000000000000000
1117771111000d0d0d0d00111511115111000d0d0d0d00111d1d1d1d11000d0d0d0d001111211111110009999940000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000e000011111ddd111100077770000011111ddd11110000000e00001111111e1111000000000000111111b311110000000000000000000000000000000000
00000e20001111ddddd1110077666600001111ddddd1110000000e20001111111e211100000007770011111b3111110000000000000000000000000000000000
000ee22200111dd1d1dd11007600006000111dd1d1dd1100000ee2220011111ee22211000009997700111a999941110000000000000000000000000000000000
00e89e0000111d11d11d11005000000600111d11d11d110000e89e00001111e89e1111000a9999960011a9d99914110000000000000000000000000000000000
00e98e0000111ddddddd11000500000000111ddddddd110000e98e00001111e98e1111000aa999900011a9dd9114110000000000000000000000000000000000
ee2ee00000111dd111dd11000055000000111dd111dd1100ee2ee0000011ee2ee11111000aaa9940001199999994110000000000000000000000000000000000
0220000000111ddddddd11000000550000111ddddddd11000220000000111221111111000aaa9400001199ddd194110000000000000000000000000000000000
0020000000111d1d1d1d11000000005500111d1d1d1d110000200000001111211111110000aaa000001119999941110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
11111111110000000000001111111111110000000070071111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111111110000000000001111111111110000000008801111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111e111100077770000011111ddd111100000ddd08801111111e1111000000b300001111111151110000077700000000000000000000000000000000000000
11111e21110077666600001111ddddd1110000dddd70071111111e211100000b3000001111111115110000777770000000000000000000000000000000000000
111ee22211007600006000111dd1d1dd11000dd0d0dd0011111ee22211000a999940001151555115110007707077000000000000000000000000000000000000
11e89e1111005000000600111d11d11d11000d00d00d001111e89e111100a9d99914001155555515110007007007000000000000000000000000000000000000
11e98e1111000500000000111ddddddd11000ddddddd001111e98e111100a9dd9114001155555551110007770777000000000000000000000000000000000000
ee2ee11111000055000000111dd111dd11000dd000dd0011ee2ee111110099999994001115111151110000777770000000000000000000000000000000000000
1221111111000000550000111ddddddd11000ddddddd001112211111110099ddd194001115111151110000707070000000000000000000000000000000000000
1121111111000000005500111d1d1d1d11000d0d0d0d001111211111110009999940001115111151110000077700000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111e11110007777000001117777111110000000e00001111111151110000000000001111177711110000000000000000000000000000000000
00000777001111111e21110077666600001177666611110000000e20001111111115110000000777001111777771110000000000000000000000000000000000
000999770011111ee2221100760000600011761111611100000ee222001151555115110000099977001117717177110000000000000000000000000000000000
0a999996001111e89e11110050000006001151111116110000e89e0000115555551511000a999996001117117117110000000000000000000000000000000000
0aa99990001111e98e11110005000000001115111111110000e98e0000115555555111000aa99990001117771777110000000000000000000000000000000000
0aaa99400011ee2ee1111100005500000011115511111100ee2ee00000111511115111000aaa9940001111777771110000000000000000000000000000000000
0aaa940000111221111111000000550000111111551111000220000000111511115111000aaa9400001111717171110000000000000000000000000000000000
00aaa000001111211111110000000055001111111155110000200000001115111151110000aaa000001111177711110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111111110000000050001111177711110000000e000011177771111100000ddd00001111177711110000077700000000000000000000000000000000000000
11111777110000000005001111777771110000000e20001177666611110000ddddd0001111777771110000777770000000000000000000000000000000000000
111999771100505550050011177171771100000ee22200117611116111000dd0d0dd001117717177110007707077000000000000000000000000000000000000
1a999996110055555505001117117117110000e89e0000115111111611000d00d00d001117117117110007007007000000000000000000000000000000000000
1aa99991110055555550001117771777110000e98e0000111511111111000ddddddd001117771777110007770777000000000000000000000000000000000000
1aaa99411100050000500011117777711100ee2ee00000111155111111000dd000dd001111777771110000777770000000000000000000000000000000000000
1aaa941111000500005000111171717111000220000000111111551111000ddddddd001111717171110000707070000000000000000000000000000000000000
11aaa11111000500005000111117771111000020000000111111115511000d0d0d0d001111177711110000077700000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
11111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
0000005000111117771111000000000000111111115111000000b300001111111e111100077770000011111ddd11110000000000000000000000000000000000
000000050011117777711100000007770011111111151100000b3000001111111e21110077666600001111ddddd1110000000000000000000000000000000000
5055500500111771717711000009997700115155511511000a9999400011111ee22211007600006000111dd1d1dd110000000000000000000000000000000000
5555550500111711711711000a9999960011555555151100a9d99914001111e89e1111005000000600111d11d11d110000000000000000000000000000000000
5555555000111777177711000aa999900011555555511100a9dd9114001111e98e1111000500000000111ddddddd110000000000000000000000000000000000
0500005000111177777111000aaa99400011151111511100999999940011ee2ee11111000055000000111dd111dd110000000000000000000000000000000000
0500005000111171717111000aaa9400001115111151110099ddd19400111221111111000000550000111ddddddd110000000000000000000000000000000000
05000050001111177711110000aaa00000111511115111000999994000111121111111000000005500111d1d1d1d110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000001111111111110000000000001111111111110000000000001111111111110000000000001111111111110000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

